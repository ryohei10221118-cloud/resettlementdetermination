<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å–®é‡æ–°çµç®—æª¢æ¸¬å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            margin-right: 10px;
            border-radius: 2px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-example {
            background: #4CAF50;
            color: white;
        }

        .btn-example:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .result-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .result-box.success {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
        }

        .result-box.warning {
            background: #fff3e0;
            border: 2px solid #ff9800;
        }

        .result-box.error {
            background: #ffebee;
            border: 2px solid #f44336;
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .result-title .icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .result-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .copy-button {
            margin-top: 15px;
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .copy-button:hover {
            background: #1976D2;
        }

        .copy-button:active {
            transform: scale(0.95);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .format-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #666;
        }

        .format-info strong {
            color: #333;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .stat-value {
                font-size: 24px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ æ³¨å–®é‡æ–°çµç®—æª¢æ¸¬å·¥å…·</h1>
            <p>æ”¯æ´äº¤æ˜“è¨˜éŒ„é™£åˆ—èˆ‡æ³¨å–®è©³æƒ… JSON å…©ç¨®æ ¼å¼</p>
        </div>

        <div class="content">
            <!-- è¼¸å…¥å€ -->
            <div class="section">
                <div class="section-title">ğŸ“¥ è¼¸å…¥æ•¸æ“š</div>

                <div class="format-info">
                    <strong>æ”¯æ´æ ¼å¼ï¼š</strong>
                    <br>â€¢ æ ¼å¼ 1ï¼šäº¤æ˜“è¨˜éŒ„é™£åˆ— (Array of transactions)
                    <br>â€¢ æ ¼å¼ 2ï¼šæ³¨å–®è©³æƒ… JSON (Ticket detail with SettlementHistory)
                </div>

                <textarea id="jsonInput" placeholder="è«‹è²¼ä¸Š JSON æ•¸æ“š..."></textarea>

                <div class="button-group">
                    <button class="btn-primary" onclick="analyzeData()">ğŸ” é–‹å§‹æª¢æ¸¬</button>
                    <button class="btn-secondary" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
                    <button class="btn-example" onclick="loadExample()">ğŸ“ è¼‰å…¥ç¯„ä¾‹</button>
                </div>
            </div>

            <!-- çµæœå€ -->
            <div class="section">
                <div id="result-trilingual" class="result-box"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒæª¢æ¸¬å‡½æ•¸ ====================

        function detectResettlement(data) {
            if (Array.isArray(data)) {
                return detectResettlementFromTransactions(data);
            }
            if (data && typeof data === 'object') {
                return detectResettlementFromTicketDetail(data);
            }
            return {
                isResettlement: false,
                method: 'Invalid data format',
                error: 'Data must be an array or object'
            };
        }

        function detectResettlementFromTransactions(transactions) {
            // FIXED: æ‰¾å‡ºæ‰€æœ‰çµç®—ç›¸é—œæ“ä½œï¼ˆcredit_customer å’Œ debit_customerï¼‰
            const settlementOperations = transactions.filter(t =>
                t.operationType === 'credit_customer' || t.reqtypeid === 12 ||
                t.operationType === 'debit_customer' || t.reqtypeid === 11
            );

            if (settlementOperations.length === 0) {
                return {
                    isResettlement: false,
                    method: 'No settlement operations found'
                };
            }

            // FIXED: æª¢æŸ¥ä»»ä½•æ“ä½œæ˜¯å¦æœ‰ IsResettlement="1" æ¨™è¨˜
            const hasResettlementFlag = settlementOperations.some(op =>
                op.reqparams && op.reqparams.includes('IsResettlement="1"')
            );

            if (settlementOperations.length === 1) {
                if (hasResettlementFlag) {
                    return {
                        isResettlement: true,
                        method: 'IsResettlement flag in XML',
                        creditCount: 1,
                        operations: settlementOperations,
                        transactionData: transactions
                    };
                }

                return {
                    isResettlement: false,
                    method: 'Single settlement operation without resettlement flag',
                    creditCount: 1
                };
            }

            const details = settlementOperations.map(op => {
                const statusMatch = op.reqparams ?
                    op.reqparams.match(/OldStatus="([^"]+)" NewStatus="([^"]+)"/) : null;

                return {
                    id: op.id,
                    date: op.creationdate,
                    amount: op.amount,
                    balance: op.balance,
                    oldStatus: statusMatch ? statusMatch[1] : 'Unknown',
                    newStatus: statusMatch ? statusMatch[2] : 'Unknown',
                    requestId: op.requestid,
                    reqparams: op.reqparams
                };
            });

            return {
                isResettlement: true,
                method: 'Multiple settlement operations',
                creditCount: settlementOperations.length,
                operations: details,
                transactionData: transactions,
                purchaseId: settlementOperations[0].opLogPurchaseId ||
                            (settlementOperations[0].queryparams ?
                             (settlementOperations[0].queryparams.match(/"purchase_id":"([^"]+)"/) || [])[1] : null)
            };
        }

        function detectResettlementFromTicketDetail(ticketDetail) {
            if (ticketDetail.SettlementHistory && Array.isArray(ticketDetail.SettlementHistory)) {
                // éæ¿¾æ‰ç¬¬ä¸€æ¬¡å¾ open (0) è®Šæˆå…¶ä»–ç‹€æ…‹çš„è¨˜éŒ„ï¼ˆé€™æ˜¯æ­£å¸¸çµç®—ï¼‰
                // åªä¿ç•™å¾é open ç‹€æ…‹è®ŠåŒ–çš„è¨˜éŒ„ï¼ˆé€™æ‰æ˜¯é‡æ–°çµç®—ï¼‰
                const resettlementRecords = ticketDetail.SettlementHistory.filter(h => h.OldBetStatus !== 0);

                if (resettlementRecords.length > 0) {
                    const settlements = resettlementRecords.map(h => ({
                        date: h.DateUpdated,
                        oldStatus: getBetStatusName(h.OldBetStatus),
                        newStatus: getBetStatusName(h.NewBetStatus),
                        gain: h.Gain,
                        previousBalance: h.PreviousBalance,
                        employeeId: h.EmployeeId,
                        accountOperationId: h.AccountOperationId
                    }));

                    return {
                        isResettlement: true,
                        method: 'Status change from settled state',
                        settlementCount: resettlementRecords.length,
                        settlements: settlements,
                        ticketId: ticketDetail.SQLTicketId,
                        purchaseId: ticketDetail.ReserveId
                    };
                }
            }

            if (ticketDetail.ProcessedInputs) {
                for (const key in ticketDetail.ProcessedInputs) {
                    const inputs = ticketDetail.ProcessedInputs[key];
                    if (Array.isArray(inputs) && inputs.length > 1) {
                        return {
                            isResettlement: true,
                            method: 'Multiple processed inputs',
                            inputCount: inputs.length,
                            processedInputs: ticketDetail.ProcessedInputs,
                            ticketId: ticketDetail.SQLTicketId
                        };
                    }
                }
            }

            return {
                isResettlement: false,
                method: 'No resettlement detected in ticket detail'
            };
        }

        // FIXED: æ­£ç¢ºçš„ç‹€æ…‹ç¢¼å°æ‡‰
        function getBetStatusName(statusCode) {
            const statusMap = {
                0: 'Opened',
                1: 'Lost',
                2: 'Won',
                3: 'Draw',
                4: 'Canceled',
                15: 'Declined',
                16: 'Half Lost',
                17: 'Half Won',
                32: 'Cashout'
            };
            return statusMap[statusCode] || `Unknown(${statusCode})`;
        }

        // ==================== è¨Šæ¯ç”Ÿæˆå™¨ ====================

        function generateQuickReplyMessage(detectionResult) {
            if (!detectionResult.isResettlement) {
                return 'âœ… æ­¤æ³¨å–®ç„¡é‡æ–°çµç®—è¨˜éŒ„';
            }

            let message = 'âš ï¸ åµæ¸¬åˆ°é‡æ–°çµç®—\n';
            message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

            if (detectionResult.ticketId) {
                message += `ğŸ“‹ æ³¨å–®ID: ${detectionResult.ticketId}\n`;
            }
            if (detectionResult.purchaseId) {
                message += `ğŸ« Purchase ID: ${detectionResult.purchaseId}\n`;
            }
            message += `ğŸ” æª¢æ¸¬æ–¹å¼: ${getMethodDescription(detectionResult.method)}\n\n`;

            if (detectionResult.settlements && detectionResult.settlements.length > 0) {
                message += `ğŸ“Š çµç®—æ­·ç¨‹ (å…± ${detectionResult.settlements.length} æ¬¡):\n`;
                message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';

                detectionResult.settlements.forEach((settlement, index) => {
                    message += `\nã€ç¬¬ ${index + 1} æ¬¡çµç®—ã€‘\n`;
                    message += `â° æ™‚é–“: ${formatDateTime(settlement.date)}\n`;
                    message += `ğŸ“ ç‹€æ…‹è®ŠåŒ–: ${settlement.oldStatus} â†’ ${settlement.newStatus}\n`;
                    message += `ğŸ’° é‡‘é¡: ${settlement.gain || 'N/A'}\n`;

                    if (settlement.previousBalance !== undefined) {
                        message += `ğŸ’µ å‰æ¬¡é¤˜é¡: ${settlement.previousBalance}\n`;
                    }

                    if (settlement.employeeId !== undefined) {
                        const isManual = settlement.employeeId > 0;
                        message += `ğŸ‘¤ æ“ä½œ: ${isManual ? 'äººå·¥ä»‹å…¥ (ID: ' + settlement.employeeId + ')' : 'ç³»çµ±è‡ªå‹•'}\n`;
                    }

                    if (index < detectionResult.settlements.length - 1) {
                        message += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
                    }
                });
            } else if (detectionResult.operations && detectionResult.operations.length > 0) {
                message += `ğŸ“Š äº¤æ˜“è¨˜éŒ„ (å…± ${detectionResult.operations.length} æ¬¡):\n`;
                message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';

                detectionResult.operations.forEach((op, index) => {
                    message += `\nã€ç¬¬ ${index + 1} æ¬¡ã€‘\n`;
                    message += `â° æ™‚é–“: ${formatDateTime(op.date)}\n`;
                    message += `ğŸ“ ç‹€æ…‹: ${op.oldStatus} â†’ ${op.newStatus}\n`;
                    message += `ğŸ’° é‡‘é¡: ${op.amount}\n`;
                    message += `ğŸ’µ é¤˜é¡: ${op.balance}\n`;

                    if (index < detectionResult.operations.length - 1) {
                        message += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
                    }
                });
            }

            message += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            message += 'âš ï¸ è«‹æ³¨æ„ï¼šæ­¤æ³¨å–®ç¶“éé‡æ–°çµç®—\n';
            message += 'å»ºè­°æ ¸å°æœ€çµ‚çµç®—é‡‘é¡èˆ‡ç‹€æ…‹';

            return message;
        }

        function generateQuickReplyMessageEN(detectionResult) {
            if (!detectionResult.isResettlement) {
                return 'âœ… No resettlement detected for this bet';
            }

            let message = 'âš ï¸ RESETTLEMENT DETECTED\n';
            message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

            if (detectionResult.ticketId) {
                message += `ğŸ“‹ Ticket ID: ${detectionResult.ticketId}\n`;
            }
            if (detectionResult.purchaseId) {
                message += `ğŸ« Purchase ID: ${detectionResult.purchaseId}\n`;
            }
            message += `ğŸ” Detection Method: ${detectionResult.method}\n\n`;

            if (detectionResult.settlements && detectionResult.settlements.length > 0) {
                message += `ğŸ“Š Settlement History (${detectionResult.settlements.length} times):\n`;
                message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';

                detectionResult.settlements.forEach((settlement, index) => {
                    message += `\nã€Settlement #${index + 1}ã€‘\n`;
                    message += `â° Time: ${formatDateTime(settlement.date)}\n`;
                    message += `ğŸ“ Status: ${settlement.oldStatus} â†’ ${settlement.newStatus}\n`;
                    message += `ğŸ’° Amount: ${settlement.gain || 'N/A'}\n`;

                    if (settlement.previousBalance !== undefined) {
                        message += `ğŸ’µ Previous Balance: ${settlement.previousBalance}\n`;
                    }

                    if (settlement.employeeId !== undefined) {
                        const isManual = settlement.employeeId > 0;
                        message += `ğŸ‘¤ Operation: ${isManual ? 'Manual (ID: ' + settlement.employeeId + ')' : 'Automatic'}\n`;
                    }

                    if (index < detectionResult.settlements.length - 1) {
                        message += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
                    }
                });
            } else if (detectionResult.operations && detectionResult.operations.length > 0) {
                message += `ğŸ“Š Transaction Log (${detectionResult.operations.length} times):\n`;
                message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';

                detectionResult.operations.forEach((op, index) => {
                    message += `\nã€Transaction #${index + 1}ã€‘\n`;
                    message += `â° Time: ${formatDateTime(op.date)}\n`;
                    message += `ğŸ“ Status: ${op.oldStatus} â†’ ${op.newStatus}\n`;
                    message += `ğŸ’° Amount: ${op.amount}\n`;
                    message += `ğŸ’µ Balance: ${op.balance}\n`;

                    if (index < detectionResult.operations.length - 1) {
                        message += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
                    }
                });
            }

            message += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            message += 'âš ï¸ Note: This bet has been resettled\n';
            message += 'Please verify the final settlement amount and status';

            return message;
        }

        // ==================== ä¸‰èªè¨€å ±å‘Šç”Ÿæˆå™¨ ====================

        function extractDetailedInfo(detectionResult, originalData) {
            if (!detectionResult.isResettlement) {
                return null;
            }

            const info = {
                betId: '',
                event: '',
                settlementHistory: '',
                eventStatus: '',  // è³½äº‹ç‹€æ…‹ï¼ˆè¢«é‡æ–°çµç®—çš„é‚£å ´è³½äº‹ï¼‰
                betStatus: '',    // æ³¨å–®ç‹€æ…‹ï¼ˆæ•´å¼µæ³¨å–®çš„æœ€çµ‚ç‹€æ…‹ï¼‰
                firstSettlementTime: '',
                lastUpdateTime: '',
                reason: ''
            };

            // å„ªå…ˆä½¿ç”¨ BetIDï¼ˆå¾ XML æå–ï¼‰æˆ– PurchaseIDï¼ˆReserveId/reserveidï¼‰
            // å…ˆå˜—è©¦å¾äº¤æ˜“é™£åˆ—çš„ XML ä¸­æå– BetID
            let extractedBetId = null;

            if (detectionResult.transactionData && Array.isArray(detectionResult.transactionData)) {
                const transactions = detectionResult.transactionData;
                const settlementOps = transactions.filter(t =>
                    (t.operationType === 'credit_customer' || t.reqtypeid === 12 ||
                     t.operationType === 'debit_customer' || t.reqtypeid === 11) &&
                    t.reqparams
                );

                // æ‰¾åˆ°æœ‰ IsResettlement="1" çš„äº¤æ˜“æˆ–æœ€å¾Œä¸€ç­†äº¤æ˜“
                let targetTransaction = settlementOps.find(op => op.reqparams && op.reqparams.includes('IsResettlement="1"'));
                if (!targetTransaction && settlementOps.length > 0) {
                    targetTransaction = settlementOps[settlementOps.length - 1];
                }

                if (targetTransaction && targetTransaction.reqparams) {
                    const xml = targetTransaction.reqparams;

                    // å˜—è©¦æå– BetIDï¼ˆå¾ <Bet> æˆ– <Change><Bets><Bet> å…ƒç´ ï¼‰
                    const betIdMatch = xml.match(/BetID="([^"]+)"/i) || xml.match(/<Bet[^>]*\sID="([^"]+)"/i);
                    if (betIdMatch && betIdMatch[1] && betIdMatch[1] !== '0') {
                        extractedBetId = betIdMatch[1];
                    }

                    // æå–è³½äº‹åç¨±ï¼ˆå¾ Selection æˆ– Lines å…ƒç´ ï¼‰
                    const eventNameMatch = xml.match(/EventName="([^"]+)"/i);
                    if (eventNameMatch) {
                        info.event = eventNameMatch[1];
                    }

                    // æå–ç‹€æ…‹è®ŠåŒ–ï¼ˆå€åˆ† Selection å’Œ Bet çš„ç‹€æ…‹ï¼‰
                    // 1. å¾ <Change> å…ƒç´ æå– Selection çš„ç‹€æ…‹è®ŠåŒ–ï¼ˆè³½äº‹ç‹€æ…‹ï¼‰
                    const changeMatch = xml.match(/<Change[^>]*\sOldStatus="([^"]+)"\s+NewStatus="([^"]+)"/i);
                    if (changeMatch) {
                        const oldSelectionStatus = changeMatch[1];
                        const newSelectionStatus = changeMatch[2];
                        info.settlementHistory = `${oldSelectionStatus} â†’ ${newSelectionStatus}`;
                        info.eventStatus = newSelectionStatus;
                    }

                    // 2. å¾ <Bet> å…ƒç´ æå–æ•´å¼µæ³¨å–®çš„ç‹€æ…‹ï¼ˆæ³¨å–®ç‹€æ…‹ï¼‰
                    const betMatch = xml.match(/<Bet[^>]*\sOldStatus="([^"]+)"\s+NewStatus="([^"]+)"/i);
                    if (betMatch) {
                        const oldBetStatus = betMatch[1];
                        const newBetStatus = betMatch[2];
                        info.betStatus = newBetStatus;
                    } else {
                        // å¦‚æœæ²’æœ‰ Bet çš„ OldStatus/NewStatusï¼Œä½¿ç”¨ Status
                        const statusMatch = xml.match(/<Bet[^>]*\sStatus="([^"]+)"/i);
                        if (statusMatch) {
                            info.betStatus = statusMatch[1];
                        }
                    }

                    // å¦‚æœåªæœ‰ä¸€å€‹ç‹€æ…‹ï¼Œå¯èƒ½æ˜¯ Change å…ƒç´ çš„ NewStatus
                    if (!info.settlementHistory) {
                        const oldStatusMatch = xml.match(/OldStatus="([^"]+)"/i);
                        const newStatusMatch = xml.match(/NewStatus="([^"]+)"/i);
                        if (oldStatusMatch && newStatusMatch) {
                            info.settlementHistory = `${oldStatusMatch[1]} â†’ ${newStatusMatch[1]}`;
                        }
                    }
                }

                // æå–æ™‚é–“ï¼ˆç¬¬ä¸€æ¬¡å’Œæœ€å¾Œä¸€æ¬¡çµç®—æ“ä½œï¼‰
                if (settlementOps.length > 0) {
                    info.firstSettlementTime = formatDateTime(settlementOps[0].creationdate);
                    info.lastUpdateTime = formatDateTime(settlementOps[settlementOps.length - 1].creationdate);
                }

                // å¦‚æœæœ‰å¤šæ¬¡çµç®—æ“ä½œï¼Œæå–å®Œæ•´çš„ç‹€æ…‹è®ŠåŒ–æ­·å²
                if (settlementOps.length > 1) {
                    const statusChanges = [];
                    for (const op of settlementOps) {
                        if (op.reqparams) {
                            const changeMatch = op.reqparams.match(/<Change[^>]*\sOldStatus="([^"]+)"\s+NewStatus="([^"]+)"/i);
                            if (changeMatch) {
                                statusChanges.push({
                                    old: changeMatch[1],
                                    new: changeMatch[2],
                                    time: formatDateTime(op.creationdate)
                                });
                            }
                        }
                    }

                    // å¦‚æœæœ‰å¤šå€‹ç‹€æ…‹è®ŠåŒ–ï¼Œæ§‹å»ºå®Œæ•´çš„æ­·å²
                    if (statusChanges.length > 1) {
                        const fullHistory = statusChanges.map((change, index) => {
                            if (index === 0) {
                                return `${change.old} â†’ ${change.new}`;
                            } else {
                                return change.new;
                            }
                        }).join(' â†’ ');
                        info.settlementHistory = fullHistory;
                    }
                }
            }

            // è¨­ç½® Bet ID çš„å„ªå…ˆç´šï¼š
            // 1. å¾ XML ä¸­æå–çš„ BetIDï¼ˆå¦‚æœæœ‰ï¼‰
            // 2. BetTicketIdï¼ˆå¾ SettlementHistory æˆ– Bets ä¸­æå–ï¼‰
            // 3. PurchaseIDï¼ˆReserveId/reserveidï¼‰
            // 4. å…¶ä»– ID
            if (extractedBetId) {
                info.betId = extractedBetId;
            } else if (Array.isArray(originalData)) {
                // äº¤æ˜“é™£åˆ—æ ¼å¼ï¼šä½¿ç”¨ reserveid (PurchaseID)
                const firstTransaction = originalData.find(t => t.reserveid);
                if (firstTransaction) {
                    info.betId = firstTransaction.reserveid;
                }
            } else if (originalData && typeof originalData === 'object') {
                // æ³¨å–®è©³æƒ…æ ¼å¼ï¼šå„ªå…ˆæå– BetTicketId
                let betTicketId = null;

                // å¾ SettlementHistory ä¸­æå– BetTicketId
                if (originalData.SettlementHistory && Array.isArray(originalData.SettlementHistory) && originalData.SettlementHistory.length > 0) {
                    betTicketId = originalData.SettlementHistory[0].BetTicketId;
                }

                // å¦‚æœæ²’æœ‰ï¼Œå¾ Bets ä¸­æå– TicketId
                if (!betTicketId && originalData.Bets && Array.isArray(originalData.Bets) && originalData.Bets.length > 0) {
                    betTicketId = originalData.Bets[0].TicketId;
                }

                // è¨­ç½® betIdï¼Œå„ªå…ˆä½¿ç”¨ BetTicketIdï¼Œç„¶å¾Œæ˜¯ ReserveId (PurchaseID)
                info.betId = betTicketId || originalData.ReserveId || originalData.SQLTicketId || originalData._id || '';
            }

            // å¦‚æœé‚„æ²’æœ‰ betIdï¼Œå¾ detectionResult ä¸­ç²å–
            if (!info.betId) {
                info.betId = detectionResult.purchaseId || detectionResult.ticketId || '';
            }

            // å¦‚æœå¾ XML ä¸­æå–åˆ°äº†è³½äº‹ä¿¡æ¯ï¼Œç›´æ¥è¿”å›
            if (info.event) {
                return info;
            }

            // å¾åŸå§‹æ•¸æ“šæå–æ›´å¤šä¿¡æ¯
            if (originalData && typeof originalData === 'object' && !Array.isArray(originalData)) {
                // æ‰¾å‡ºè¢«é‡æ–°çµç®—çš„è³½äº‹ï¼ˆå¾ ProcessedInputs ä¸­æ‰¾å‡ºæœ‰å¤šå€‹çµç®—è¨˜éŒ„çš„ Selectionï¼‰
                let resettledSelectionId = null;
                if (originalData.ProcessedInputs && originalData.SettlementHistory) {
                    // ç¢ºä¿æ‰€æœ‰ ID éƒ½è½‰æ›ç‚ºå­—ç¬¦ä¸²é€²è¡Œæ¯”è¼ƒ
                    const settlementOperationIds = originalData.SettlementHistory.map(h => String(h.AccountOperationId));

                    for (const [selectionId, operationIds] of Object.entries(originalData.ProcessedInputs)) {
                        // æ‰¾å‡ºåœ¨ SettlementHistory ä¸­å‡ºç¾çš„æ“ä½œï¼ˆç¢ºä¿é¡å‹ä¸€è‡´ï¼‰
                        const matchingOps = operationIds.filter(opId =>
                            settlementOperationIds.includes(String(opId))
                        );
                        if (matchingOps.length >= 2) {
                            resettledSelectionId = selectionId;
                            break;
                        }
                    }
                }

                // å¾ Selections ä¸­æå–è³½äº‹åç¨±å’Œç‹€æ…‹
                if (resettledSelectionId && originalData.Selections && Array.isArray(originalData.Selections)) {
                    const selection = originalData.Selections.find(s => s.MarketId === resettledSelectionId || s.SelectionId === resettledSelectionId);
                    if (selection) {
                        info.event = selection.EventName || selection.Team1Name + ' vs ' + selection.Team2Name || '';

                        // æå–è©²å ´è³½äº‹çš„ç‹€æ…‹ï¼ˆeventStatusï¼‰
                        if (selection.SelectionStatus !== undefined) {
                            info.eventStatus = getBetStatusName(selection.SelectionStatus);
                        }
                    }
                }

                // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç°¡å–®æ–¹æ³•
                if (!info.event) {
                    if (originalData.Event || originalData.EventName) {
                        info.event = originalData.Event || originalData.EventName;
                    } else if (originalData.Selections && originalData.Selections.length > 0) {
                        // ä½¿ç”¨ç¬¬ä¸€å€‹ Selection çš„è³½äº‹åç¨±
                        const firstSel = originalData.Selections[0];
                        info.event = firstSel.EventName || (firstSel.Team1Name + ' vs ' + firstSel.Team2Name) || '';
                    }
                }

                // æå–çµç®—æ­·å²ï¼ˆåªåŒ…å«é‡æ–°çµç®—è¨˜éŒ„ï¼Œæ’é™¤ç¬¬ä¸€æ¬¡å¾ open è®Šæˆå…¶ä»–ç‹€æ…‹çš„æ­£å¸¸çµç®—ï¼‰
                if (originalData.SettlementHistory && Array.isArray(originalData.SettlementHistory)) {
                    // éæ¿¾æ‰ç¬¬ä¸€æ¬¡å¾ open (0) è®Šæˆå…¶ä»–ç‹€æ…‹çš„è¨˜éŒ„
                    const resettlementRecords = originalData.SettlementHistory.filter(h => h.OldBetStatus !== 0);

                    if (resettlementRecords.length > 0) {
                        const first = resettlementRecords[0];
                        const last = resettlementRecords[resettlementRecords.length - 1];

                        // betStatus ç¸½æ˜¯é¡¯ç¤ºæ•´å¼µæ³¨å–®çš„æœ€çµ‚ç‹€æ…‹
                        info.betStatus = getBetStatusName(last.NewBetStatus);

                        // settlementHistory é¡¯ç¤ºè¢«é‡æ–°çµç®—è³½äº‹çš„ç‹€æ…‹è®ŠåŒ–
                        if (resettledSelectionId && originalData.Selections) {
                            const resettledSelection = originalData.Selections.find(s =>
                                s.MarketId === resettledSelectionId || s.SelectionId === resettledSelectionId
                            );

                            if (resettledSelection && resettledSelection.SelectionStatus !== undefined) {
                                // æ¨æ–·è©²å ´è³½äº‹çš„ç‹€æ…‹è®ŠåŒ–
                                if (resettledSelection.SelectionStatus === 17) { // Half Won
                                    // æª¢æŸ¥æ•´å€‹ Bet å¾ä»€éº¼ç‹€æ…‹è®ŠåŒ–è€Œä¾†
                                    const oldBetStatus = first.OldBetStatus;
                                    if (oldBetStatus === 1) { // å¦‚æœæ•´å€‹ Bet æ›¾ç¶“æ˜¯ Lost
                                        info.settlementHistory = 'Lost â†’ Half Won';
                                    } else {
                                        info.settlementHistory = 'Won â†’ Half Won';
                                    }
                                } else if (resettledSelection.SelectionStatus === 16) { // Half Lost
                                    const oldBetStatus = first.OldBetStatus;
                                    if (oldBetStatus === 2) { // å¦‚æœæ•´å€‹ Bet æ›¾ç¶“æ˜¯ Won
                                        info.settlementHistory = 'Won â†’ Half Lost';
                                    } else {
                                        info.settlementHistory = 'Lost â†’ Half Lost';
                                    }
                                } else {
                                    // å…¶ä»–æƒ…æ³ï¼Œä½¿ç”¨æ•´å€‹ Bet çš„ç‹€æ…‹è®ŠåŒ–
                                    info.settlementHistory = `${getBetStatusName(first.OldBetStatus)} â†’ ${getBetStatusName(last.NewBetStatus)}`;
                                }
                            } else {
                                // æ²’æ‰¾åˆ° selectionï¼Œä½¿ç”¨æ•´å€‹ Bet çš„ç‹€æ…‹è®ŠåŒ–
                                info.settlementHistory = `${getBetStatusName(first.OldBetStatus)} â†’ ${getBetStatusName(last.NewBetStatus)}`;
                            }
                        } else {
                            // å–®å ´æ³¨å–®æˆ–æ²’æ‰¾åˆ° resettled selectionï¼Œä½¿ç”¨æ•´å€‹ Bet çš„ç‹€æ…‹è®ŠåŒ–
                            info.settlementHistory = `${getBetStatusName(first.OldBetStatus)} â†’ ${getBetStatusName(last.NewBetStatus)}`;
                        }

                        // æ™‚é–“
                        info.firstSettlementTime = formatDateTime(first.DateUpdated);
                        info.lastUpdateTime = formatDateTime(last.DateUpdated);
                    }
                }
            }

            return info;
        }

        function generateTrilingualReport(info) {
            if (!info) {
                return 'ç„¡æ³•ç”Ÿæˆå ±å‘Šï¼šæœªæª¢æ¸¬åˆ°é‡æ–°çµç®—';
            }

            // ä¸­æ–‡ç‰ˆ
            const chinese = `æ³¨å•å·ï¼š${info.betId}
èµ›äº‹ï¼š${info.event || '(å¾…å¡«å…¥)'}
èµ›äº‹é‡æ–°ç»“ç®—å†å²ï¼š${info.settlementHistory}
èµ›äº‹çŠ¶æ€ï¼š${info.eventStatus || info.betStatus}
æ³¨å•çŠ¶æ€ï¼š${info.betStatus}
ç¬¬ä¸€æ¬¡ç»“ç®—æ—¶é—´ï¼š${info.firstSettlementTime}
æœ€åæ›´æ–°æ—¶é—´ï¼š${info.lastUpdateTime}
é‡æ–°ç»“ç®—åŸå› ï¼š${info.reason}`;

            // è‹±æ–‡ç‰ˆ
            const english = `Bet ID: ${info.betId}
Event: ${info.event || '(To be filled)'}
Event Resettlement History: ${info.settlementHistory}
Event Status: ${info.eventStatus || info.betStatus}
Bet Status: ${info.betStatus}
First Settlement Time: ${info.firstSettlementTime}
Last Update Time: ${info.lastUpdateTime}
Reason for Resettlement: ${info.reason}`;

            // éŸ“æ–‡ç‰ˆ
            const korean = `ë² íŒ… ë²ˆí˜¸: ${info.betId}
ì´ë²¤íŠ¸: ${info.event || '(ì…ë ¥ í•„ìš”)'}
ê²½ê¸° ì¬ì •ì‚° ë‚´ì—­: ${info.settlementHistory}
ê²½ê¸° ìƒíƒœ: ${info.eventStatus || info.betStatus}
ë² íŒ… ìƒíƒœ: ${info.betStatus}
ì²« ë²ˆì§¸ ì •ì‚° ì‹œê°„: ${info.firstSettlementTime}
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„: ${info.lastUpdateTime}
ì¬ì •ì‚° ì‚¬ìœ : ${info.reason}`;

            return {
                chinese,
                english,
                korean,
                combined: `ã€ä¸­æ–‡ã€‘\n${chinese}\n\nã€Englishã€‘\n${english}\n\nã€í•œêµ­ì–´ã€‘\n${korean}`
            };
        }

        // ==================== è¼”åŠ©å‡½æ•¸ ====================

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                // ä½¿ç”¨ UTC æ™‚é–“ç¢ºä¿é¡¯ç¤ºç‚º UTC+0
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');

                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} (UTC+0)`;
            } catch (e) {
                return dateString;
            }
        }

        function getMethodDescription(method) {
            const methodMap = {
                'Multiple settlement history entries': 'å¤šæ¬¡çµç®—è¨˜éŒ„',
                'Multiple settlement operations': 'å¤šæ¬¡çµç®—æ“ä½œ',
                'Status change from settled state': 'å¾å·²çµç®—ç‹€æ…‹è®Šæ›´',
                'Multiple processed inputs': 'å¤šæ¬¡è™•ç†è¼¸å…¥',
                'IsResettlement flag in XML': 'XMLé‡æ–°çµç®—æ¨™è¨˜'
            };
            return methodMap[method] || method;
        }

        // ==================== UI å‡½æ•¸ ====================

        let currentData = null; // ä¿å­˜ç•¶å‰æ•¸æ“šä»¥ä¾›ä¸‰èªè¨€å ±å‘Šä½¿ç”¨

        function analyzeData() {
            const input = document.getElementById('jsonInput').value.trim();

            if (!input) {
                alert('è«‹å…ˆè¼¸å…¥ JSON æ•¸æ“šï¼');
                return;
            }

            try {
                // ä¿®å¾©å¤§æ•´æ•¸ç²¾åº¦å•é¡Œï¼šå°‡ ID å­—æ®µè½‰æ›ç‚ºå­—ç¬¦ä¸²
                // é€™æ¨£å¯ä»¥é¿å… JavaScript æ•¸å­—ç²¾åº¦ä¸Ÿå¤±ï¼ˆè¶…é 2^53-1 çš„æ•´æ•¸ï¼‰
                let fixedInput = input
                    // 1. è½‰æ›ç‰©ä»¶ä¸­çš„ ID å­—æ®µï¼ˆå¦‚ "ReserveId": 123 â†’ "ReserveId": "123"ï¼‰
                    .replace(/"(ReserveId|SQLTicketId|BetTicketId|TicketId|AccountOperationId|BetId|reserveid|_id|InputId)"\s*:\s*(\d{15,})/g,
                             '"$1": "$2"')
                    // 2. è½‰æ›é™£åˆ—ä¸­çš„å¤§æ•´æ•¸ï¼ˆå¦‚ [123, 456] â†’ ["123", "456"]ï¼‰
                    .replace(/(\[|,)\s*(\d{15,})/g, '$1"$2"')
                    // 3. ä¿®æ­£è¢«éŒ¯èª¤è½‰æ›çš„æ•¸å­—ï¼ˆå¦‚é™£åˆ—çµå°¾ï¼‰
                    .replace(/"(\d{15,})"\s*(\]|,)/g, '"$1"$2');

                const data = JSON.parse(fixedInput);
                currentData = data; // ä¿å­˜åŸå§‹æ•¸æ“š
                const result = detectResettlement(data);

                displayResult(result, data);
            } catch (error) {
                showError('JSON æ ¼å¼éŒ¯èª¤ï¼š' + error.message);
            }
        }

        function displayResult(result, originalData) {
            const trilingualBox = document.getElementById('result-trilingual');
            const boxClass = result.isResettlement ? 'warning' : 'success';
            const icon = result.isResettlement ? 'âš ï¸' : 'âœ…';

            // ä¸‰èªè¨€å ±å‘Š
            const detailedInfo = extractDetailedInfo(result, originalData);
            const trilingualReport = generateTrilingualReport(detailedInfo);

            if (result.isResettlement && trilingualReport.chinese) {
                trilingualBox.className = `result-box ${boxClass}`;
                trilingualBox.style.display = 'block';
                trilingualBox.innerHTML = `
                    <div class="result-title">
                        <span class="icon">ğŸŒ</span>
                        é‡æ–°çµç®—å ±å‘Š / Resettlement Report / ì¬ì •ì‚° ë³´ê³ ì„œ
                    </div>

                    <div style="margin-top: 25px;">
                        <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #1976D2; margin-bottom: 20px;">
                            <div style="font-weight: 600; color: #1976D2; margin-bottom: 10px; font-size: 16px;">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç‰ˆæœ¬</div>
                            <div class="result-content" style="background: rgba(25, 118, 210, 0.05);">${trilingualReport.chinese}</div>
                            <button class="copy-button" onclick="copyToClipboard('${escapeHtml(trilingualReport.chinese)}', this)">ğŸ“‹ è¤‡è£½ä¸­æ–‡</button>
                        </div>

                        <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #43A047; margin-bottom: 20px;">
                            <div style="font-weight: 600; color: #43A047; margin-bottom: 10px; font-size: 16px;">ğŸ‡¬ğŸ‡§ English Version</div>
                            <div class="result-content" style="background: rgba(67, 160, 71, 0.05);">${trilingualReport.english}</div>
                            <button class="copy-button" onclick="copyToClipboard('${escapeHtml(trilingualReport.english)}', this)">ğŸ“‹ Copy English</button>
                        </div>

                        <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #E53935; margin-bottom: 20px;">
                            <div style="font-weight: 600; color: #E53935; margin-bottom: 10px; font-size: 16px;">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ë²„ì „</div>
                            <div class="result-content" style="background: rgba(229, 57, 53, 0.05);">${trilingualReport.korean}</div>
                            <button class="copy-button" onclick="copyToClipboard('${escapeHtml(trilingualReport.korean)}', this)">ğŸ“‹ í•œêµ­ì–´ ë³µì‚¬</button>
                        </div>

                        <div style="text-align: center; margin-top: 25px;">
                            <button class="copy-button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 15px; padding: 12px 40px;" onclick="copyToClipboard('${escapeHtml(trilingualReport.combined)}', this)">ğŸ“‹ è¤‡è£½å…¨éƒ¨ä¸‰ç¨®èªè¨€ / Copy All / ëª¨ë“  ì–¸ì–´ ë³µì‚¬</button>
                        </div>
                    </div>
                `;
            } else {
                trilingualBox.className = 'result-box success';
                trilingualBox.style.display = 'block';
                trilingualBox.innerHTML = `
                    <div class="result-title">
                        <span class="icon">âœ…</span>
                        ç„¡é‡æ–°çµç®— / No Resettlement / ì¬ì •ì‚° ì—†ìŒ
                    </div>
                    <div class="result-content">æ­¤æ³¨å–®ç„¡éœ€ç”Ÿæˆä¸‰èªè¨€å ±å‘Š<br>No trilingual report needed for this bet<br>ì´ ë² íŒ…ì— ëŒ€í•œ ë‹¤êµ­ì–´ ë³´ê³ ì„œê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
                `;
            }
        }

        function showError(message) {
            const trilingualBox = document.getElementById('result-trilingual');
            trilingualBox.className = 'result-box error';
            trilingualBox.style.display = 'block';
            trilingualBox.innerHTML = `
                <div class="result-title">
                    <span class="icon">âŒ</span>
                    éŒ¯èª¤ / Error / ì˜¤ë¥˜
                </div>
                <div class="result-content">${message}</div>
            `;
        }

        function clearAll() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('result-trilingual').style.display = 'none';
            currentData = null;
        }

        function copyToClipboard(text, button) {
            // è§£ç¢¼ HTML å¯¦é«”
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            const decodedText = textarea.value;

            navigator.clipboard.writeText(decodedText).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ… å·²è¤‡è£½ï¼';
                button.style.background = '#4CAF50';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
            });
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/\n/g, '\\n');
        }

        // ==================== ç¯„ä¾‹æ•¸æ“š ====================

        function loadExample() {
            const example = {
                "SQLTicketId": 774027361405546497,
                "ReserveId": 774027361405546497,
                "Event": "Benfica vs Bayer Leverkusen",
                "SettlementHistory": [
                    {
                        "DateUpdated": "2025-11-05T21:54:44Z",
                        "OldBetStatus": 0,
                        "NewBetStatus": 2,
                        "Gain": 1500,
                        "PreviousBalance": 0,
                        "EmployeeId": 0,
                        "AccountOperationId": "774027400000000001"
                    },
                    {
                        "DateUpdated": "2025-11-06T00:47:27Z",
                        "OldBetStatus": 2,
                        "NewBetStatus": 1,
                        "Gain": -1500,
                        "PreviousBalance": 1500,
                        "EmployeeId": 1001,
                        "AccountOperationId": "774027400000000002"
                    }
                ],
                "ProcessedInputs": {
                    "BenficaVsBayerLeverkusen": [
                        774027400000000001,
                        774027400000000002
                    ]
                }
            };

            document.getElementById('jsonInput').value = JSON.stringify(example, null, 2);
        }
    </script>
</body>
</html>
